name: Continuous Benchmark Shard Transfer Speed

on:
  workflow_dispatch:
    inputs:
      dataset_name:
        description: 'Dataset name'
        default: 'laion-small-clip'
        type: string
      qdrant_versions:
        description: 'Comma-separated versions to compare (ghcr/dev, docker/master, docker/v1.13.0). Can be just single version.'
        default: 'ghcr/dev,docker/v1.16.3'
        type: string
      region:
        description: 'Hetzner region'
        default: 'fsn1'
        type: string
      server_type:
        description: 'Hetzner server type'
        default: 'ccx13'
        type: string
      client_type:
        description: 'Hetzner client type'
        default: 'cx33'
        type: string
  push:
    branches:
      - transfer-speed-benchmark
#  schedule:
#    - cron: "0 4 * * *"  # Daily at 4am UTC

concurrency:
  group: hetzner-machines

env:
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
  # Defaults for push trigger (inputs.* is empty on push)
  SERVER_TYPE: ${{ inputs.server_type || 'ccx13' }}
  CLIENT_TYPE: ${{ inputs.client_type || 'cx33' }}
  REGION: ${{ inputs.region || 'fsn1' }}
  DATASET_NAME: ${{ inputs.dataset_name || 'laion-small-clip' }}
  QDRANT_VERSIONS: ${{ inputs.qdrant_versions || 'ghcr/dev,docker/v1.16.3' }}

jobs:
  setupCluster:
    name: Setup ${{ matrix.machine.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        machine:
          - name: node-0
            server_name_suffix: node-0
            server_type_env: SERVER_TYPE
          - name: node-1
            server_name_suffix: node-1
            server_type_env: SERVER_TYPE
          - name: client
            server_name_suffix: client
            server_type_env: CLIENT_TYPE
    outputs:
      node_names: transfer-bench-node-0-${{ github.run_id }},transfer-bench-node-1-${{ github.run_id }}
      client_name: transfer-bench-client-${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup CI tools
        run: bash -x tools/setup_ci.sh

      - name: Create machine
        uses: ./.github/workflows/actions/create-server-with-retry
        with:
          server_name: transfer-bench-${{ matrix.machine.server_name_suffix }}-${{ github.run_id }}
          server_type: ${{ matrix.machine.server_type_env == 'CLIENT_TYPE' && env.CLIENT_TYPE || env.SERVER_TYPE }}
          region: ${{ env.REGION }}
          max_retries: 2

  runBenchmark:
    name: Run Transfer Benchmark
    needs: setupCluster
    runs-on: ubuntu-latest
    container: alpine/ansible:2.18.1
    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Create inventory
        uses: ./.github/workflows/actions/create-inventory
        with:
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          server_names: ${{ needs.setupCluster.outputs.node_names }}
          client_names: ${{ needs.setupCluster.outputs.client_name }}
          db_host: ${{ secrets.POSTGRES_HOST }}
      - name: Run benchmarks for all versions
        run: |
          echo "$QDRANT_VERSIONS" | tr ',' '\n' | while read -r QDRANT_VERSION; do
            QDRANT_VERSION=$(echo "$QDRANT_VERSION" | xargs)  # trim whitespace
            [ -z "$QDRANT_VERSION" ] && continue

            echo "=========================================="
            echo "Benchmarking Qdrant version: $QDRANT_VERSION"
            echo "=========================================="

            case "${QDRANT_VERSION}" in
              docker/*)
                CONTAINER_REGISTRY="docker.io"
                VERSION=${QDRANT_VERSION#docker/}
                ;;
              ghcr/*)
                CONTAINER_REGISTRY="ghcr.io"
                VERSION=${QDRANT_VERSION#ghcr/}
                ;;
              *)
                echo "Error: unknown version ${QDRANT_VERSION}. Version name should start with 'docker/' or 'ghcr/'"
                exit 1
                ;;
            esac

            ansible-playbook ansible/playbooks/playbook-transfer-speed.yml \
              -i ansible/playbooks/inventory.ini \
              --extra-vars "dataset_name=${DATASET_NAME} server_registry=${CONTAINER_REGISTRY} server_version=${VERSION}"
          done
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_SSH_ARGS: "-o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ControlMaster=no"
          ANSIBLE_STDOUT_CALLBACK: yaml
          QDRANT_VERSIONS: ${{ env.QDRANT_VERSIONS }}
          DATASET_NAME: ${{ env.DATASET_NAME }}

  cleanup:
    name: Cleanup Cluster
    needs: [setupCluster, runBenchmark]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup CI tools
        run: bash -x tools/setup_ci.sh
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      - name: Delete cluster nodes and client
        run: |
          NODE_NAMES="${{ needs.setupCluster.outputs.node_names }}"
          CLIENT_NAME="${{ needs.setupCluster.outputs.client_name }}"

          # Build list of all machines to delete
          ALL_MACHINES=()
          IFS=',' read -ra NODES <<< "$NODE_NAMES"
          for NODE in "${NODES[@]}"; do
            if [ -n "$NODE" ]; then
              ALL_MACHINES+=("$NODE")
            fi
          done
          if [ -n "$CLIENT_NAME" ]; then
            ALL_MACHINES+=("$CLIENT_NAME")
          fi

          echo "Deleting ${#ALL_MACHINES[@]} machines in parallel..."

          # Launch all deletions in parallel
          PIDS=()
          for MACHINE in "${ALL_MACHINES[@]}"; do
            (
              echo "Deleting $MACHINE..."
              bash tools/hetzner/remove_server.sh "$MACHINE"
            ) &
            PIDS+=($!)
          done

          # Wait for all deletions to complete
          FAILED=0
          for i in "${!PIDS[@]}"; do
            if wait ${PIDS[$i]}; then
              echo "Deleted ${ALL_MACHINES[$i]}"
            else
              echo "Failed to delete ${ALL_MACHINES[$i]}"
              FAILED=$((FAILED + 1))
            fi
          done

          if [ $FAILED -gt 0 ]; then
            echo "Warning: $FAILED deletion(s) failed"
          fi
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}