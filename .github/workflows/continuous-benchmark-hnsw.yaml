name: Continuous Benchmark Hnsw Indexing

on:
  workflow_dispatch:
  schedule:
    # Run every day at 5am
    - cron: "0 5 * * *"

# Restrict to only running this workflow one at a time.
# Any new runs will be queued until the previous run is complete.
# Any existing pending runs will be cancelled and replaced with current run.
concurrency:
  group: continuous-benchmark

jobs:
  createInventory:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up environment and create inventory.ini
        id: create-inventory
        run: |
          export HCLOUD_TOKEN=${{ secrets.HCLOUD_TOKEN }}
          export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          export POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          export SERVER_NAME="benchmark-server-3"
          bash -x tools/setup_ci.sh

          IP_OF_THE_SERVER=$(bash "tools/hetzner/get_public_ip.sh" "$SERVER_NAME")

          # Create ansible inventory.ini file
          cat <<EOL > inventory.ini
          [remote_machines]
          benchmark-machine ansible_host=${IP_OF_THE_SERVER} ansible_user=root
          [db_hosts]
          benchmark-db ansible_host=${POSTGRES_HOST} ansible_user=root
          EOL

          # Save inventory.ini for the next step
          mkdir -p output
          mv inventory.ini output/inventory.ini
      - name: Upload inventory.ini
        uses: actions/upload-artifact@v4
        with:
          name: inventory
          path: output/inventory.ini

  runUpdateHealingBenchmark:
    runs-on: ubuntu-latest
    container: alpine/ansible:2.18.1
    needs: createInventory
    steps:
      - uses: actions/checkout@v3
      - name: Download inventory.ini
        uses: actions/download-artifact@v4
        with:
          name: inventory
          path: ansible/playbooks
      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Run bench
        id: hnsw-indexing-002
        run: |
          cd ansible/playbooks && ansible-playbook playbook-hnsw-index.yml --extra-vars "bench=002"

  runTransformHealingBenchmark:
    runs-on: ubuntu-latest
    container: alpine/ansible:2.18.1
    needs: runUpdateHealingBenchmark
    steps:
      - uses: actions/checkout@v3
      - name: Download inventory.ini
        uses: actions/download-artifact@v4
        with:
          name: inventory
          path: ansible/playbooks
      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Run bench
        id: hnsw-indexing-003
        run: |
            cd ansible/playbooks && ansible-playbook playbook-hnsw-index.yml --extra-vars "bench=003"
