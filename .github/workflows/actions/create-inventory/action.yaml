name: Create inventory
description: "Prepare inventory.ini"
inputs:
  hcloud_token:
    description: "Hetzner Cloud API token"
    required: true
  server_names:
    description: "Space-separated list of server names"
    required: true
  client_names:
    description: "Space-separated list of client names (optional)"
    required: false
    default: ""
  db_host:
    description: "Database host"
    required: true

runs:
  using: "composite"
  steps:
    - name: Create inventory.ini
      shell: bash
      run: |
        export HCLOUD_TOKEN=${{ inputs.hcloud_token }}
        export POSTGRES_HOST=${{ inputs.db_host }}

        apk add --no-cache jq || apt-get install -y jq

        # Download and install hcloud
        HCVERSION=v1.36.0
        wget https://github.com/hetznercloud/cli/releases/download/${HCVERSION}/hcloud-linux-amd64.tar.gz
        tar xzf hcloud-linux-amd64.tar.gz
        mv hcloud /usr/local/bin
        chmod +x /usr/local/bin/hcloud

        # Create ansible inventory.ini file
        echo "[remote_machines]" > inventory.ini

        # Add each server to inventory
        i=0
        for SERVER_NAME in ${{ inputs.server_names }}; do
          PUBLIC_IP=$(bash "tools/hetzner/get_public_ip.sh" "$SERVER_NAME")
          PRIVATE_IP=$(bash "tools/hetzner/get_private_ip.sh" "$SERVER_NAME")
          echo "node-${i} ansible_host=${PUBLIC_IP} private_ip=${PRIVATE_IP} ansible_user=root" >> inventory.ini
          i=$((i + 1))
        done

        # Add client_machines group if client_names is provided
        CLIENT_NAMES="${{ inputs.client_names }}"
        if [ -n "$CLIENT_NAMES" ]; then
          echo "" >> inventory.ini
          echo "[client_machines]" >> inventory.ini
          i=0
          for CLIENT_NAME in $CLIENT_NAMES; do
            IP=$(bash "tools/hetzner/get_public_ip.sh" "$CLIENT_NAME")
            echo "client-${i} ansible_host=${IP} ansible_user=root" >> inventory.ini
            i=$((i + 1))
          done
        fi

        # Add db_hosts group
        echo "" >> inventory.ini
        echo "[db_hosts]" >> inventory.ini
        echo "benchmark-db ansible_host=${POSTGRES_HOST} ansible_user=root" >> inventory.ini

        mv inventory.ini ansible/playbooks/inventory.ini
    - name: Prepare datasets.yml
      shell: bash
      run: |
        if ! command -v yq &> /dev/null; then
          apk add --no-cache yq || apt-get install -y yq || true
        fi
        echo -e "datasets:\n" > ansible/playbooks/group_vars/datasets.yml
        yq -p json -o yaml datasets/datasets.json >> ansible/playbooks/group_vars/datasets.yml
